
trigger:
  branches:
    include:
      - main

variables:
  location: 'australiaeast'
  templateFile: 'infra/core/main.bicep'

  # JSON param files
  devParamJson:  'infra/params/dev.json'
  testParamJson: 'infra/params/test.json'
  prodParamJson: 'infra/params/prod.json'

  # Resource groups
  devRgName:  'rg-ai-core-dev'
  testRgName: 'rg-ai-core-test'
  prodRgName: 'rg-ai-core-prod'

stages:
# =======================
# Stage 1: Deploy Dev
# =======================
- stage: Deploy_Dev
  displayName: 'Deploy - Dev'
  jobs:
  - job: DeployDev
    displayName: 'Deploy Dev baseline'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
    - task: AzureCLI@2
      displayName: 'Deploy Dev'
      inputs:
        azureSubscription: 'SC-Azure-DevOps-Dev'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -euo pipefail
          az group create -n "${{ variables.devRgName }}" -l "${{ variables.location }}"
          az deployment group create \
            --resource-group "${{ variables.devRgName }}" \
            --template-file "${{ variables.templateFile }}" \
            --parameters @"${{ variables.devParamJson }}"

# =======================
# Stage 2: Approval Gate (Test)
# =======================
- stage: Approve_Test
  displayName: 'Approval Gate - Test'
  dependsOn: Deploy_Dev
  jobs:
  - job: WaitForApprovalTest
    environment: 'test'   # Project Settings -> Environments -> test -> add approvers
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: echo "Awaiting approval to deploy to Test..."
      displayName: 'Approval placeholder'

# =======================
# Stage 3: Deploy Test
# =======================
- stage: Deploy_Test
  displayName: 'Deploy - Test'
  dependsOn: Approve_Test
  jobs:
  - job: DeployTest
    displayName: 'Deploy Test'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
    - task: AzureCLI@2
      displayName: 'Deploy Test'
      inputs:
        azureSubscription: 'SC-Azure-DevOps-Test'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -euo pipefail
          az group create -n "${{ variables.testRgName }}" -l "${{ variables.location }}"
          az deployment group create \
            --resource-group "${{ variables.testRgName }}" \
            --template-file "${{ variables.templateFile }}" \
            --parameters @"${{ variables.testParamJson }}"

# =======================
# Stage 4: Approval Gate (Prod)
# =======================
- stage: Approve_Prod
  displayName: 'Approval Gate - Prod'
  dependsOn: Deploy_Test
  jobs:
  - job: WaitForApprovalProd
    environment: 'prod'   # Project Settings -> Environments -> prod -> add approvers
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: echo "Awaiting approval to deploy to Prod..."
      displayName: 'Approval placeholder'

# =======================
# Stage 5: Deploy Prod
# =======================
- stage: Deploy_Prod
  displayName: 'Deploy - Prod'
  dependsOn: Approve_Prod
  jobs:
  - job: DeployProd
    displayName: 'Deploy Prod'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
    - task: AzureCLI@2
      displayName: 'Deploy Prod'
      inputs:
        azureSubscription: 'SC-Azure-DevOps-Prod'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -euo pipefail
          az group create -n "${{ variables.prodRgName }}" -l "${{ variables.location }}"
          az deployment group create \
            --resource-group "${{ variables.prodRgName }}" \
            --template-file "${{ variables.templateFile }}" \
            --parameters @"${{ variables.prodParamJson }}"

